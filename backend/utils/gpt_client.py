"""
OpenAI GPT APIë¥¼ í™œìš©í•œ ì¸ìŠ¤íƒ€ê·¸ë¨ ì½˜í…ì¸  ìƒì„± í´ë¼ì´ì–¸íŠ¸
ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¸ìŠ¤íƒ€ê·¸ë¨ìš© ì„¤ëª…ê¸€ê³¼ í•´ì‹œíƒœê·¸ë¥¼ ìë™ ìƒì„±í•©ë‹ˆë‹¤.
"""

import os
import openai
from dotenv import load_dotenv

# .env íŒŒì¼ì—ì„œ í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

class GPTClient:
    """OpenAI GPT API í´ë¼ì´ì–¸íŠ¸ í´ë˜ìŠ¤"""
    
    def __init__(self):
        """GPT í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”"""
        self.api_key = os.getenv('OPENAI_API_KEY')
        if not self.api_key:
            raise ValueError("OPENAI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. .env íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
        
        # OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        self.client = openai.OpenAI(api_key=self.api_key)
        
    def generate_instagram_content(self, title, content, category=None):
        """
        ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¸ìŠ¤íƒ€ê·¸ë¨ìš© ì½˜í…ì¸ ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        
        Args:
            title (str): ë‰´ìŠ¤ ì œëª©
            content (str): ë‰´ìŠ¤ ë³¸ë¬¸
            category (str): ë‰´ìŠ¤ ì¹´í…Œê³ ë¦¬ (ì„ íƒì‚¬í•­)
            
        Returns:
            dict: ìƒì„±ëœ ì¸ìŠ¤íƒ€ê·¸ë¨ ì½˜í…ì¸ 
                - description: ì¸ìŠ¤íƒ€ê·¸ë¨ìš© ì„¤ëª…ê¸€
                - hashtags: í•´ì‹œíƒœê·¸ ë¦¬ìŠ¤íŠ¸
        """
        try:
            # ì¹´í…Œê³ ë¦¬ ì •ë³´ í¬í•¨ ì—¬ë¶€ í™•ì¸
            category_info = f"\nì¹´í…Œê³ ë¦¬: {category}" if category else ""
            
            # GPT í”„ë¡¬í”„íŠ¸ êµ¬ì„±
            prompt = f"""
ë‹¤ìŒ ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë§¤ë ¥ì ì¸ ì¸ìŠ¤íƒ€ê·¸ë¨ í¬ìŠ¤íŒ…ìš© ì½˜í…ì¸ ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.

ì œëª©: {title}
ë³¸ë¬¸: {content[:1000]}...{category_info}

ì¶œë ¥ í˜•ì‹ (ì •í™•íˆ ì´ í˜•íƒœë¡œ):
[ë‰´ìŠ¤ ì œëª©ì„ ë§¤ë ¥ì ìœ¼ë¡œ ì¬ì‘ì„±]

1ï¸âƒ£ [ì²« ë²ˆì§¸ í•µì‹¬ í¬ì¸íŠ¸ ì œëª©]
[ì²« ë²ˆì§¸ í¬ì¸íŠ¸ì— ëŒ€í•œ êµ¬ì²´ì  ì„¤ëª…]
2ï¸âƒ£ [ë‘ ë²ˆì§¸ í•µì‹¬ í¬ì¸íŠ¸ ì œëª©]  
[ë‘ ë²ˆì§¸ í¬ì¸íŠ¸ì— ëŒ€í•œ êµ¬ì²´ì  ì„¤ëª…]
3ï¸âƒ£ [ì„¸ ë²ˆì§¸ í•µì‹¬ í¬ì¸íŠ¸ ì œëª©]
[ì„¸ ë²ˆì§¸ í¬ì¸íŠ¸ì— ëŒ€í•œ êµ¬ì²´ì  ì„¤ëª…]
4ï¸âƒ£ [ë„¤ ë²ˆì§¸ í•µì‹¬ í¬ì¸íŠ¸ ì œëª©] (í•„ìš”ì‹œ)
[ë„¤ ë²ˆì§¸ í¬ì¸íŠ¸ì— ëŒ€í•œ êµ¬ì²´ì  ì„¤ëª…]

ê²½ì œÂ·ì‚°ì—…Â·ìƒí™œÂ·ì‚¬íšŒ
ê°€ì¥ ë¹ ë¥¸ ì†ë³´ëŠ” ì—¬ê¸°ğŸ‘‰ @economy_dragon_

#í•µì‹¬í‚¤ì›Œë“œ1 #í•µì‹¬í‚¤ì›Œë“œ2 #í•µì‹¬í‚¤ì›Œë“œ3 #í•µì‹¬í‚¤ì›Œë“œ4 #ë‰´ìŠ¤

ì‘ì„± ê°€ì´ë“œ:
- ğŸ”¥ğŸ’¡ğŸ“Šâš¡ ë“± ì„íŒ©íŠ¸ ìˆëŠ” ì´ëª¨ì§€ í™œìš©
- "ì™„ì „ ë¯¸ì¹œ", "ë ˆì „ë“œ", "ã„·ã„·" ë“± ì Šì€ ê°ê°ì˜ í‘œí˜„ ì‚¬ìš©
- ìˆ«ìì™€ ë°ì´í„°ë¥¼ ê°•ì¡°í•˜ì—¬ ì„íŒ©íŠ¸ ì¦ëŒ€
- ë…ìì˜ í˜¸ê¸°ì‹¬ì„ ìê·¹í•˜ëŠ” ë¬¸ì²´
- í•´ì‹œíƒœê·¸ëŠ” ì •í™•íˆ 5ê°œë§Œ (ë§ˆì§€ë§‰ì€ ë°˜ë“œì‹œ #ë‰´ìŠ¤)
- ì¤„ë°”ê¿ˆì„ ì ì ˆíˆ ì‚¬ìš©í•˜ì—¬ ê°€ë…ì„± í–¥ìƒ
- "ê²½ì œÂ·ì‚°ì—…Â·ìƒí™œÂ·ì‚¬íšŒ" ë° "@economy_dragon_" ë¬¸êµ¬ëŠ” ë°˜ë“œì‹œ í¬í•¨

ì°¸ê³  ì˜ˆì‹œ:
ë¶í•œì— ìŒ€ë³‘ ë³´ë‚´ë ¤ë˜ ë¯¸êµ­ì¸ 6ëª… ê°•í™”ë„ì„œ í˜„ì¥ ê²€ê±°

1ï¸âƒ£ ìƒˆë²½ì˜ ë¯¸ìŠ¤í„°ë¦¬, ë¶í•œí–‰ ìŒ€ë³‘
ç¾ì‹œë¯¼ 6ëª…, ê°•í™”ë„ í•´ì•ˆì„œ ìŒ€Â·ë‹¬ëŸ¬Â·ì„±ê²½ ë‹´ê¸´ í˜íŠ¸ë³‘ 1300ì—¬ ê°œ ë¶í•œìœ¼ë¡œ ë³´ë‚´ë ¤ë‹¤ ë¶™ì¡í˜€.
2ï¸âƒ£ êµ°ë¶€ëŒ€ ì‹ ê³ ë¡œ ë°œê°
ì¸ê·¼ êµ°ë¶€ëŒ€ê°€ ìˆ˜ìƒí•œ ì›€ì§ì„ ê°ì§€ í›„ ì¦‰ì‹œ ê²½ì°° ì‹ ê³ . ì¦‰ê° ì²´í¬ë¼ ì¡°ì‚¬ ì¤‘.

ê²½ì œÂ·ì‚°ì—…Â·ìƒí™œÂ·ì‚¬íšŒ
ê°€ì¥ ë¹ ë¥¸ ì†ë³´ëŠ” ì—¬ê¸°ğŸ‘‰ @economy_dragon_

#ê°•í™”ë„ #ë¶í•œ #ë¯¸êµ­ì¸ #í˜„ì¥ê²€ê±° #ë‰´ìŠ¤
"""

            # GPT API í˜¸ì¶œ (gpt-4o-mini ì‚¬ìš© - ê°€ì„±ë¹„ ì¢‹ìŒ)
            response = self.client.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {
                        "role": "system", 
                        "content": "ë‹¹ì‹ ì€ ì†Œì…œë¯¸ë””ì–´ ë§ˆì¼€íŒ… ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ ë§¤ë ¥ì ì¸ ì¸ìŠ¤íƒ€ê·¸ë¨ ì½˜í…ì¸ ë¡œ ë³€í™˜í•˜ëŠ” ê²ƒì´ ì „ë¬¸ì…ë‹ˆë‹¤."
                    },
                    {
                        "role": "user", 
                        "content": prompt
                    }
                ],
                max_tokens=1000,
                temperature=0.7
            )
            
            # ì‘ë‹µ íŒŒì‹±
            generated_content = response.choices[0].message.content
            
            # ì´ì œ í†µí•©ëœ í˜•íƒœë¡œ ë°˜í™˜ (íŒŒì‹± ì—†ì´ ì „ì²´ í…ìŠ¤íŠ¸ ì‚¬ìš©)
            return {
                'success': True,
                'content': generated_content.strip(),
                'raw_response': generated_content
            }
            
        except Exception as e:
            return {
                'success': False,
                'error': str(e),
                'content': '',
                'raw_response': ''
            }
    
    def generate_quick_hashtags(self, title, category=None):
        """
        ì œëª©ë§Œìœ¼ë¡œ ë¹ ë¥´ê²Œ í•´ì‹œíƒœê·¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        
        Args:
            title (str): ë‰´ìŠ¤ ì œëª©
            category (str): ë‰´ìŠ¤ ì¹´í…Œê³ ë¦¬ (ì„ íƒì‚¬í•­)
            
        Returns:
            dict: ìƒì„±ëœ í•´ì‹œíƒœê·¸
        """
        try:
            category_info = f" (ì¹´í…Œê³ ë¦¬: {category})" if category else ""
            
            prompt = f"""
ë‹¤ìŒ ë‰´ìŠ¤ ì œëª©ì— ì í•©í•œ ì¸ìŠ¤íƒ€ê·¸ë¨ í•´ì‹œíƒœê·¸ 10ê°œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”:

ì œëª©: {title}{category_info}

ìš”êµ¬ì‚¬í•­:
- í•œêµ­ì–´ì™€ ì˜ì–´ í•´ì‹œíƒœê·¸ í˜¼í•©
- íŠ¸ë Œë“œ ë°˜ì˜
- ë‰´ìŠ¤ ë‚´ìš©ê³¼ ê´€ë ¨ì„± ë†’ê²Œ

ì‘ë‹µ í˜•ì‹: #íƒœê·¸1 #íƒœê·¸2 #íƒœê·¸3 ...
"""

            response = self.client.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {
                        "role": "system", 
                        "content": "í•´ì‹œíƒœê·¸ ìƒì„± ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ê°„ê²°í•˜ê³  íš¨ê³¼ì ì¸ í•´ì‹œíƒœê·¸ë§Œ ìƒì„±í•´ì£¼ì„¸ìš”."
                    },
                    {
                        "role": "user", 
                        "content": prompt
                    }
                ],
                max_tokens=200,
                temperature=0.7
            )
            
            hashtags_text = response.choices[0].message.content
            hashtag_list = [tag.strip() for tag in hashtags_text.split('#') if tag.strip()]
            
            return {
                'success': True,
                'hashtags': hashtag_list
            }
            
        except Exception as e:
            return {
                'success': False,
                'error': str(e),
                'hashtags': []
            } 